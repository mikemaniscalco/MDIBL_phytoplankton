---
title: "MDIBL_access_data_to_csv"
author: "Michael Maniscalco"
date: '2022-06-21'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(lubridate)
library(janitor)
```

```{r load}
phyto_db <- read_excel("phyto_access_db.xlsx") %>%
  filter_at(vars("Program",
                 "Site Name",
                 "Station Number"), 
            any_vars(!is.na(.)))  

phyto_db <- phyto_db %>%
  rename(
    funding_source="Program",
    site="Site Name",
    locationID="Station Number",
    date="Date",      
    time="Time 24Hrs",
    rain_inches="Inches of Rain",
    tide_height="Tide",
    time_low_tide="Time of Low Tide",
    time_high_tide="Time of High Tide",
    water_temp="Water Temp °C",
    air_temp="Air Temp °C",
    wind_speed_knots="Wind Speed (Knots)",
    maximumDepthInMeters="Tow Depth    Meters", #this is a Darwin Core Variable name
    transparency_depth_mean="Transparency Depth Meters",
    salinity_ppt="Salinity    ppt",
    water_current="Current",
    weather="Weather",
    water_surface="Water Surface",
    field_comments="Field Comments",
    DO1_ppm="DO 1 (ppm)",
    DO2_ppm="DO 2 (ppm)",
    DOavg_ppm="DO Avg.",
    DO1_day5_ppm="DO(5) 1",
    DO2_day5_ppm="DO(5) 2",
    DO2_day5_avg="DO(5) Avg.",
    BOD_date ="BOD Date",
    bod = "BOD",
    Chaetoceros_spp ="Chaetoceros",
    Chaetoceros_socialis ="Chaetoceros socialis",
    Ditylum="Didylum",
    Dinophysis_spp= "Dinophysis",
    Licmophora= "Lycomorpha",
    Nitzschia= "Nitzchia",
    Prorocentrum_spp= "Prorocentrum",
    Prorocentrum_lima="Prorocentrum lima",
    Pseudo_nitzchia_spp ="Pseudo-nitzchia",
    Other_phytoplankton= "Other",
    dominant_phytoplankter1="Dominant Species 1",
    total_phytoplankton ="Total Phytoplankton",
    lab_comments="Lab Comments",
    tide_stage="Tide Stage",
    date_emailed_to_DMR ="Date E-Mailed to DMR",
    monitor_names = "Monitor Name",
    sampling_method="Sample Method",
    dominant_phytoplankter2="Dominant Species 2",
    dominant_phytoplankter3="Dominant Species 3",  
    Gymnodinium= "Gymnodinium",  
    wind_direction="Wind Direction",    
    nitrate_plus_nitrite="Nitrate + Nitrite",    
    ammonium="Ammonia",      
    orthophosphate="Orthophosphate",
    silicate="Silica",        
    Pseudo_nitzschia_small="P.nitzschia small",       
    Pseudo_nitzschia_large="P.nitzschia large",         
    too_numerous_to_count_grid_num="TNTC at cell",             
    nutrient_vial_id= "Nutrient Vial #") %>%
  relocate(Gymnodinium, .after= Guinardia) %>%
  relocate(Pseudo_nitzschia_small, Pseudo_nitzschia_large, .before= Pseudo_nitzchia_spp) %>%
  relocate(BOD_date, .after=time_high_tide) %>%
  relocate(rain_inches, .after=weather) %>%
  relocate(water_temp, .after=air_temp) %>%
  relocate(weather, .after=water_temp) %>%
  relocate(rain_inches, .after=weather) %>%
  relocate(water_surface, .after=rain_inches) %>% 
  relocate(water_current, .after=water_surface) %>%
  relocate(wind_direction, .before=wind_speed_knots) %>%
  relocate(wind_direction:wind_speed_knots, .after=rain_inches) %>%
  relocate(tide_height, .after=water_current) %>%
  relocate(tide_stage, .after=water_current) %>%
  relocate(lab_comments, .after=field_comments) %>%
  relocate(salinity_ppt, .after=lab_comments) %>%
  relocate(maximumDepthInMeters, .after=sampling_method) %>%
  relocate(monitor_names, .before=field_comments) %>%
  relocate(transparency_depth_mean, .before=nitrate_plus_nitrite) %>%
  relocate(date_emailed_to_DMR,.after=time) %>%
  relocate(sampling_method:maximumDepthInMeters, .before=Alexandrium) %>%
  relocate(transparency_depth_mean:silicate, .before=Alexandrium) %>%
  relocate(nutrient_vial_id, .before=nitrate_plus_nitrite) %>%
  add_column(decimalLatitude=NA,.after="locationID") %>%
  add_column(decimalLongitude=NA,.after="decimalLatitude") 
```

```{r comments}
phyto_db <- phyto_db %>%
  unite(., eventRemarks, lab_comments,field_comments, sep = "|", remove = TRUE)
```

### Tide height ft to meters

```{r tide height}
phyto_db <- phyto_db %>%
  mutate(tide_height=tide_height*0.3048)
```

### Drop unwanted columns

```{r drop}
phyto_db <- phyto_db %>%
  select(
    # -date_emailed_to_DMR,
    -dominant_phytoplankter1,
    -dominant_phytoplankter2,
    -dominant_phytoplankter3,
    -funding_source)
```

### Time Conversions

-   3 sampling times before 2am--\> real or entered in 12 h instead of 24h time?
-   several occasions of no time entered
    -   Use time of 23:59:59 to represent no time recorded

```{r}
time_question<- phyto_db %>%
  filter(between(hour(hms::as_hms(time)), 0, 5))
## talked with Jane who assured me that the times earlier than 5am where meant to be input as time in PM --> corrected in excel file

write_csv(time_question,"time_check.csv")
rm(time_question)

phyto_db <- phyto_db %>%
  mutate(time = as.character(gsub(".* ","",time)),
         time_low_tide = as.character(gsub(".* ","",time_low_tide)),
         time_high_tide = as.character(gsub(".* ","",time_high_tide)),
         date = ymd(date,tz ="America/New_York"),
         BOD_date = ymd(BOD_date,tz ="America/New_York"),
         date_emailed_to_DMR=ymd(date_emailed_to_DMR)) %>%
  mutate(time=replace_na(time,  "23:59:59" ),
         time_low_tide=replace_na(time_low_tide,  "23:59:59" ),
         time_high_tide=replace_na(time_high_tide,  "23:59:59" )) %>%
  mutate(eventDate = as.POSIXct(paste(date,time),
                                      format="%Y-%m-%d %H:%M:%S",
                                      tz ="America/New_York"),
         time_low_tide = as.POSIXct(paste(date,time_low_tide),
                                      format="%Y-%m-%d %H:%M:%S",
                                      tz ="America/New_York"),
         time_high_tide = as.POSIXct(paste(date,time_high_tide),
                                      format="%Y-%m-%d %H:%M:%S",
                                      tz ="America/New_York")
         ) %>%
  relocate(eventDate,time_low_tide,time_high_tide, .after = time) %>%
  select(-time, -date,-time_low_tide,-time_high_tide)
```

### Rainfall

-   Convert inches to mm

```{r rainfall}
# rainfall inches to mm 1 inch = 25.4
phyto_db <- phyto_db %>%
  mutate(rainfall_mm= rain_inches*25.4) %>%
  select(-rain_inches)
```

### Monitor names

-   First make a csv of unique names to create a key for later conversion of names into standardized version

```{r monitor}
monitor_name_df <-select(phyto_db, eventDate, monitor_names) %>%
  dplyr::rename(monitor = monitor_names) %>%
  drop_na() %>%
  mutate(., monitor=str_replace(monitor, "Kubeck. Jones", "Kubeck, Jones")) %>%
  mutate(., monitor=str_replace(monitor, "Burne. Kubeck", "Burne, Kubeck")) %>%
  mutate(., monitor=str_replace(monitor, "co. ", "")) %>%
  mutate(., monitor=str_replace(monitor, "Co. ", "")) %>%
  mutate(., monitor= str_replace_all(monitor, " &", ",")) %>%
  mutate(., monitor=str_replace_all(monitor, " and ", ", ")) %>%
  mutate(., monitor=str_replace_all(monitor, "/", ", ")) %>%
  mutate(., monitor=str_replace_all(monitor, " \\+", ", ")) %>%
  mutate(., monitor=str_replace(monitor, " \\+", ", ")) %>%
  separate_rows(monitor ,sep = ", ") %>%
  separate_rows(monitor ,sep = ",") %>%
  filter(., str_detect(monitor, '[a-zA-Z]')) %>%
  mutate(., monitor =trimws(monitor, "l")) %>%
  mutate(., monitor =trimws(monitor, "r")) %>%
  distinct(monitor, .keep_all = T) %>%
  arrange(monitor)

write_csv(monitor_name_df, "monitor_name_key_template.csv")
rm(monitor_name_df)
```

#### Use key to harmonize names of Monitors

```{r }
key_names <- read_csv("corrected_in_R/monitor_name_key.csv") %>%
  select(-Date) %>%
  distinct(monitor, .keep_all = T) %>%
  # filter(., monitor!=monitor_unified) %>%
  mutate(monitor= paste0("|", monitor,"|")) %>%
  mutate(monitor_unified= paste0("|", monitor_unified,"|"))

phyto_db <- phyto_db %>%
  mutate(., monitor_names=str_replace(monitor_names, "Kubeck. Jones", "Kubeck, Jones")) %>%
  mutate(., monitor_names=str_replace(monitor_names, "Burne. Kubeck", "Burne, Kubeck")) %>%
  mutate(., monitor_names=str_replace(monitor_names, " co.", "")) %>%
  mutate(., monitor_names=str_replace(monitor_names, " Co.", "")) %>%
  mutate(., monitor_names=str_replace_all(monitor_names, ",|&|\\+|/| and ", "\\|")) %>%
  mutate(., monitor_names=str_replace_all(monitor_names, "\\| ", "\\|")) %>%
  mutate(., monitor_names=str_replace_all(monitor_names, " \\|", "\\|")) %>%
  mutate_at(vars(monitor_names), ~replace_na(., "not_recorded")) %>%
  separate(., col = monitor_names, 
           into = c("monitor_name1", 
                    "monitor_name2", 
                    "monitor_name3", 
                    "monitor_name4", 
                    "monitor_name5"),
           sep = "\\|",
           remove = T,
           extra = "merge") %>%
  mutate(across(c("monitor_name1", 
                  "monitor_name2",
                  "monitor_name3",
                  "monitor_name4",
                  "monitor_name5"),
                ~paste0("|", .x,"|"))) %>%
  mutate_at(vars(monitor_name1,
                       monitor_name2,
                       monitor_name3,
                       monitor_name4,
                       monitor_name5), 
            funs(key_names$monitor_unified[match(., key_names$monitor)])) %>%
  mutate(across(c("monitor_name1", 
                  "monitor_name2",
                  "monitor_name3",
                  "monitor_name4",
                  "monitor_name5"),
                ~str_replace_all(.x,"\\|",""))) %>%
  unite(monitor_names, c(monitor_name1, 
                         monitor_name2,
                         monitor_name3,
                         monitor_name4,
                         monitor_name5), sep = "|", remove = T) %>%
  mutate(monitor_names = str_replace_all(monitor_names,"\\|NA",""))
rm(key_names)
```

### Wind direction

```{r wind direct}
phyto_db <- phyto_db %>%  
  mutate(wind_direction =na_if(wind_direction, "Not Recorded"),
         wind_direction =str_replace(wind_direction, "None", "999"),
         wind_direction=str_replace(wind_direction, "NNW", "337.5"), 
         wind_direction=str_replace(wind_direction, "NW", "315"),
         wind_direction=str_replace(wind_direction, "NE", "35"),
         wind_direction=str_replace(wind_direction, "SE", "135"),
         wind_direction=str_replace(wind_direction, "SW", "225"),
         wind_direction =str_replace(wind_direction, "No wind", "999"),
         wind_direction=str_replace(wind_direction, "W", "270"),
         wind_direction=str_replace(wind_direction, "E", "90"),
         wind_direction=str_replace(wind_direction, "N", "0"),
         wind_direction=str_replace(wind_direction, "S", "90")
        ) 
```

### Nutrient ID

```{r wind direct}
phyto_db <- phyto_db %>%  
  mutate(nutrient_vial_id =na_if(nutrient_vial_id, 0)) 
```

### Salinity

-   Change the three values \<15 to NA

```{r wind direct}
phyto_db <- phyto_db %>%  
  mutate(salinity_ppt =ifelse(salinity_ppt<15,NA,salinity_ppt)) 
```

### Tide stage

-   change the values "high" "R" and "Alex" to NA (or any values other than "In" and "Out")
    -   It as only one instance of each

```{r tides}
phyto_db <- phyto_db %>%
  mutate(tide_stage=ifelse(str_detect(tide_stage,"In|Out"),tide_stage, NA))
```

### Water current

-   Values should be "High", "Medium", "Low, "None", or NA --\> fix to get rid of "?"

```{r currents}
phyto_db <- phyto_db %>%
  mutate(water_current=ifelse(str_detect(water_current,"High|Medium|Low|None"),water_current, NA))
```

### Weather

-   Unrestricted text field
-   data through 2021 February include:
    -   "Partly Cloudy", "Clear", "Overcast", "Drizzle", "Fog", "Downpour", NA

### Water surface

-   Unrestricted text field
-   data through 2021 February include: "Ripple" "Calm" "Whitecaps" "Waves" NA "31"
    -   Value "31" does not fit

```{r water_surface}
phyto_db <- phyto_db %>%
  mutate(water_surface=ifelse(water_surface=="31",NA,water_surface ))
```

### Character vectors to numeric

```{r}
phyto_db <- phyto_db %>%
  mutate(across(c(nitrate_plus_nitrite,
                  ammonium,
                  orthophosphate,
                  silicate,
                  Pseudo_nitzschia_small,
                  Pseudo_nitzschia_large,
                  too_numerous_to_count_grid_num),
                ~as.numeric(.x))) %>%
  mutate(across(nitrate_plus_nitrite:total_phytoplankton,~replace_na(.x, 0))) 
```

### Pseudo-nitzschia counts

-   2013-10-18 08:15:00 entry has PN small counts entered as 3.95, PN large entered at 105 and PN spp entered as 500. It seems clear that PN small count was 395 not 3.95
-   The "Small" and "Large" sub-types of PN were added at some point
-   Pseudo-nitzschia spp. is in some cases all PN cells that were counted, in other cases it is the sum of the large and the small (which is still all PN counted), but in other cases Pseudo-nitzschia spp does not equal the sum of PN small and large.... is that because they are medium sized? what is going on there?
-   I would like to have three unique columns, PN small, PN large, and PN Spp.
    -   This would allow anyone using the data to easily sum them together without double counting cells

```{r}
phyto_db <- phyto_db %>%
  mutate(Pseudo_nitzschia_small= ifelse(Pseudo_nitzschia_small==3.95, 395, Pseudo_nitzschia_small)) %>%
  mutate(Pseudo_nitzschia_small= ifelse(eventDate=="2013-06-25 13:31:00", NA, Pseudo_nitzschia_small),
         Pseudo_nitzschia_large= ifelse(eventDate=="2013-06-25 13:31:00", NA, Pseudo_nitzschia_large), 
         Pseudo_nitzchia_spp=ifelse(eventDate== "2013-08-16 08:20:00", NA, Pseudo_nitzchia_spp),
         Pseudo_nitzchia_spp=ifelse(eventDate=="2013-08-20 09:10:00", NA, Pseudo_nitzchia_spp),
         Pseudo_nitzchia_spp=ifelse(eventDate== "2013-10-11 06:00:00", NA, Pseudo_nitzchia_spp),
         Pseudo_nitzchia_spp=ifelse(eventDate== "2014-05-28 10:37:00", NA, Pseudo_nitzchia_spp))

PN <-select(phyto_db,
            eventDate,
            Pseudo_nitzschia_small,
            Pseudo_nitzschia_large, 
            Pseudo_nitzchia_spp) %>%
  mutate(PN_sm_plus_lg= (Pseudo_nitzschia_small+Pseudo_nitzschia_large)) %>%
  # prevent double counting of PN small/large in PN spp. column
  mutate(Pseudo_nitzchia_spp=ifelse(Pseudo_nitzchia_spp==PN_sm_plus_lg,
                                    0, 
                                    Pseudo_nitzchia_spp))
rm(PN)
```

### Total phytoplankton

```{r}
counts <- phyto_db %>%
  select(eventDate, sampling_method,maximumDepthInMeters,Alexandrium:Other_phytoplankton,Pseudo_nitzchia_spp,Pseudo_nitzschia_large,Pseudo_nitzschia_small,Gymnodinium,total_phytoplankton) %>%
  mutate(across(Alexandrium:Gymnodinium,~replace_na(.x, 0))) %>%
  mutate(sum_phytos =  rowSums(across(Alexandrium:Other_phytoplankton))) %>%
  relocate(sum_phytos, .after=total_phytoplankton)

sum_less_than_total <- counts %>%  
  filter(total_phytoplankton > 0) %>%
  filter(sum_phytos < total_phytoplankton)

sum_more_than_total <- counts %>%
  filter(total_phytoplankton > 0) %>%
  filter(sum_phytos > total_phytoplankton)

## Spot checking the 50 entries it seems like there were addition errors and inconsistencies as to whether additional taxa identified and counted but not named on the typed on sheet were to be included in the total. Total_phytoplankton will be recalculated directly from data present
rm(counts, sum_less_than_total, sum_more_than_total)
```

### Site names and locations

-   Cruise ship file uses different coordinates for "bar harbor pier" that are further from land incongruous with description or incorrect coordinates?

```{r}
site_names <- phyto_db %>%
  mutate(site=str_replace(site, "MDIBL dock|mdibl dock|.*MDIBL.*","MDIBL Dock"))%>%
  select( site, locationID, eventDate, monitor_names) %>%
  distinct( site, locationID,.keep_all = T) %>%
  arrange(locationID, site) 

write_csv(site_names,"site_names.csv")
rm(site_names)

phyto_db <- phyto_db %>%
  mutate(site=str_replace(site, "MDIBL dock|mdibl dock|.*MDIBL.*","MDIBL Dock"))%>%
  mutate(site=str_replace(site, "BH Town Pier","Bar Harbor Town Pier"))%>%
  mutate(site= str_replace(site, "eastern bay channel", "Eastern Bay Channel"),
         site= str_replace(site, "Surry - Town Landing", "Surry Town Pier"),
         site= str_replace(site, "Stave", "Stave Island"),
         site= str_replace(site, "Lamoine Shore", "Lamoine Beach"),
         site= str_replace(site, "Brooksville Town Landing", "Brooksville Town Dock"))

site_names_corrected <- read_csv("site_details.csv")

phyto_db <- left_join(select(phyto_db,-c(locationID,decimalLatitude,decimalLongitude)),
                      site_names_corrected, by="site") %>%
  select(-locationID) %>%
  rename(locationID=suggested_locationID) %>%
  relocate(locationID:coordinateUncertaintyInMeters, .after=site)
rm(site_names_corrected)
```

### Sampling methods

-   What units are counts in at different points in time
-   Do we want to separate into different data units?

```{r method}
filtration_depth <- phyto_db %>%
  filter(sampling_method=="Filter") %>%
  drop_na(maximumDepthInMeters)
write_csv(filtration_depth,"filter_depth.csv")

tow_no_depth <- phyto_db %>%
  filter(sampling_method=="Tow") %>%
  filter(is.na(maximumDepthInMeters))
write_csv(tow_no_depth,"tow_no_depth.csv")

# Use 1m as default for the 3 samples where tow depth (maximumDepthInMeters) was not specified. Log sheets did not have depth recorded either.
phyto_db <-phyto_db %>%
  mutate(maximumDepthInMeters= ifelse(sampling_method=="Tow" & is.na(maximumDepthInMeters)==T,
                           1, 
                           maximumDepthInMeters))
# Assign appropriate sampling_method when not provided based on eventDate and maximumDepthInMeters
phyto_db <-phyto_db %>%
  mutate(sampling_method=ifelse(is.na(sampling_method)==T & eventDate<"2007-05-09 23:59:59", "Tow",sampling_method    )) %>%
  mutate(sampling_method=ifelse(is.na(sampling_method)==T & eventDate>"2007-05-09 23:59:59" & is.na(maximumDepthInMeters)==T, "Filter",sampling_method ))  %>%
# change maximumDepthInMeters value to 1 if NA but check lowest actual tow depth to make sure it differs
  add_column(minimumDepthInMeters= 0.5) # change value to 0.5 if NA 

rm(tow_no_depth,filtration_depth)
```

### Add additional Darwin Core columns

```{r darwin columns}
phyto_db <- phyto_db %>%
  mutate(eventDate=strftime(eventDate , "%Y-%m-%dT%H:%M:%S%Z",tz = "Zulu")) %>%
  add_column(countryCode="US") %>%
  mutate(eventID= paste(locationID,  eventDate, sep="_")) %>% 
  mutate(id= paste("MDIBL-habs", locationID,  eventDate, sep="_")) %>% 
  add_column(geodeticDatum="EPSG:4326 WGS84")
```

### Write static tables for historic data

```{r write historic}
phyto_db <- phyto_db %>%
  select(-c(nutrient_vial_id:silicate),
         too_numerous_to_count_grid_num=too_numerous_to_count_grid_num) %>%
  relocate(minimumDepthInMeters, .before="maximumDepthInMeters") %>%
  relocate(transparency_depth_mean, .before="sampling_method") %>%
  relocate(rainfall_mm, .after="weather") %>% 
  relocate(geodeticDatum, .before="decimalLatitude") %>%
  relocate(id:eventID, .before="site") %>%
  relocate(countryCode, .after="decimalLongitude")

phyto_db %>%
  filter(., sampling_method=="Tow") %>%
  filter(., eventDate <"2007-01-01T00:00:00UTC") %>%
  write_csv(., "tow/MDIBL_phyto_db_tow2004_2006.csv")

phyto_db %>%
  filter(., sampling_method=="Tow") %>%
  filter(., eventDate >"2007-01-01T00:00:00UTC") %>%
  write_csv(., "tow/MDIBL_phyto_db_tow2007.csv")

phyto_db %>%
  filter(., sampling_method=="Filter") %>%
  write_csv(., "filtered_water/MDIBL_phyto_db_filter2007_2021.csv")
rm(phyto_db)
```


```{r }
library(worrms)
# Edit below chunk to adapt
## Update taxonomic coverage
# build emld list of taxonomic coverage
dwc_o_records$authority <- "worms"
taxon_coverage <- taxonomyCleanr::make_taxonomicCoverage(
  taxa.clean = dwc_o_records$scientificname,
  authority = dwc_o_records$authority,
  authority.id = dwc_o_records$AphiaID,
  write.file = FALSE)

eml_doc$dataset$coverage$taxonomicCoverage <- taxon_coverage
```
