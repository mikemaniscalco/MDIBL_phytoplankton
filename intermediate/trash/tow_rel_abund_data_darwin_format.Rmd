---
title: "Tow data into Darwin Archive format"
author: "Michael Maniscalco"
date: '2022-06-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(lubridate)
library(janitor)
```

### Load tow data

```{r load}
df_tow <- read_csv("tow/MDIBL_phyto_db_tow2004_2006.csv") %>%
    arrange(eventDate)
```

### Create event file

```{r event}
tow_events <- df_tow %>%
  select(id, eventID,	eventDate, geodeticDatum,	countryCode, locationID, 
         eventRemarks,	decimalLatitude,	decimalLongitude,	minimumDepthInMeters,
         maximumDepthInMeters,	coordinateUncertaintyInMeters)

write_csv(tow_events,"tow/tow_rel_abund_events.csv")
rm(tow_events)
```

### Create occurrence table and save as csv
* Pivot phytoplankton count data to long to 
* Additionional Darwin core fields needed to be added
* Recalculating "Total phytoplankton" 
* Convert counts into relative abundance
* Select columns to keep in desired order
* Save csv

```{r}
tax_table <- read_excel("tax_table.xlsx") %>%
  select(-names_originally_in_access_db,-names_in_anecdata)

tow_occurrence <- df_tow %>%
    select(-c(Pseudo_nitzschia_small:Pseudo_nitzchia_spp, data_for_Kate:only_alexandrium_counted)) %>% # these columns are empty for tow data. PN not seen in area until later
  rowwise() %>%
  mutate(total_phytoplankton=sum(c_across((Alexandrium:Other_phytoplankton)))) %>%
  mutate(across(Alexandrium:Other_phytoplankton, ~.x/total_phytoplankton)) %>%
  pivot_longer(., cols=(Alexandrium:Other_phytoplankton),
                 names_to = "organismName",
               values_to = "organismQuantity"
               ) %>%
  filter(organismQuantity>0) %>%
  left_join(.,tax_table, by="organismName") %>%
  add_column(basisOfRecord="HumanObservation", .after="id") %>%
  add_column(organismQuantityType= "Relative Abundance", .after="organismQuantity") %>% 
  mutate(occurrenceID=paste(eventDate, organismName, sep="_")) %>%
  add_column(occurrenceStatus="present") %>%
  select(id, basisOfRecord,organismName, organismQuantity, organismQuantityType,
         occurrenceID, occurrenceStatus, scientificName, scientificNameID, taxonID, kingdom)

write_csv(tow_occurrence,"tow/tow_rel_abund_occurence.csv")
rm(tax_table, tow_occurrence)
```

### Create ExtendedMeasurementOrFact table
id	measurementType	measurementValue	measurementID	measurementTypeID	measurementUnit	measurementUnitID

```{r}
extended_base <- read_csv("columns_units.csv") %>%
  filter(darwin_file=="all"|darwin_file=="ExtendedMeasurementOrFact")

tow_extended <- df_tow %>%
  select(-monitor_names, -c(Alexandrium:grids_counted)) %>% 
  mutate(across(air_temp:transparency_depth_mean, ~as.character(.x))) %>%
  pivot_longer(., 
               cols=(air_temp:transparency_depth_mean),
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementValue=ifelse(measurementType=="rainfall_mm" & measurementValue=="0",
                                 NA, 
                                 measurementValue)) %>%
  filter(!is.na(measurementValue)) %>%
  left_join(., extended_base, by= "measurementType") %>%
  select(.,id, measurementType,	measurementValue,	measurementID,
         measurementTypeID,	measurementUnit,
         measurementUnitID # is this one optional?
         )

write_csv(tow_extended,"tow/tow_rel_abund_extended.csv")
```


### Tax tree for EDI?

```{r }
library(worrms)

# Edit below chunk to adapt

## Update taxonomic coverage

# build emld list of taxonomic coverage
dwc_o_records$authority <- "worms"
taxon_coverage <- taxonomyCleanr::make_taxonomicCoverage(
  taxa.clean = dwc_o_records$scientificname,
  authority = dwc_o_records$authority,
  authority.id = dwc_o_records$AphiaID,
  write.file = FALSE)

eml_doc$dataset$coverage$taxonomicCoverage <- taxon_coverage
```







