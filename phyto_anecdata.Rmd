---
title: "Anecadata phyto clean"
author: "Michael Maniscalco"
date: '2022-06-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyverse)
library(lubridate)
library(janitor)
```

### Load Anecdata phyto download
* Remove unwanted fields
* Separate "hotspot" into locationID and site name
* Rename several columns into a more machine/human readable format
* Concatenate various comments fields into one Column

```{r load}
anecdata_db <- read_csv("source_data/maine_phytoplankton_monitoring-2022-06-13_03.21.46.csv") %>%
  filter(!str_detect(username,"MarkWhiting")) %>%
  select(-license, 
         -license_url, 
         -geoprivacy, 
         -event, 
         -c(country:postcode),
         -c(observation_notes:Abundance), 
         -`Nutrient_bath_temperature_(C)`,
         -c("Phytoplankton_(Dominant_Species_1)":"Date_e_mailed_to_DMR"),
         -c("Image 1":"Image 5"),
         -Microplastics_Sampling_Type,
         -c("Blue__Round":"Microplastics_Notes"),
         -c("Frequency_(Dominant_Species_1)":"Frequency_(Dominant_Species_2)"),
         -Zooplankton_Frequency,
         -username,
         -id,
         -row_id) %>%
  separate(., col = hotspot, 
           into = c("locationID",
                    "site"),
           sep = " ",
           remove = T,
           extra = "merge") %>%
  rename(
        decimalLatitude="lat",
        decimalLongitude="lng",
        # "site",
        eventDate ="observed",
        water_temp="Water_Temperature_(_C)_(C)",
        air_temp="Air_temperature_(_C)_(Â°C)",
        transparency_depth_mean="Transparency_(m)",
        salinity_ppt="Salinity_(ppt)",
        DOavg_ppm="Dissolved_Oxygen",
        water_current="Current_(relative)",
        nutrient_vial_id="Nutrient_Vial_Number",
        Pseudo_nitzschia_large="__of_LARGE_Pseudo_nitzschia",
        Pseudo_nitzschia_small="__of_SMALL_Pseudo_nitzschia",
        Dinophysis_acuminata="__of_Dinophysis_acuminata",     
        Alexandrium="__of_Alexandrium",   
        Dinophysis_norvegica="__of_Dinophysis_norvegica", 
        Dinophysis_spp="__of_Dinophysis_spp__(unknown)", 
        Prorocentrum_lima="__of_Prorocentrum_lima", 
        Margalefidinium_polykrikoides="__of_Margalefidinium_p_", 
        Karenia="__of_Karenia", 
        too_numerous_to_count_grid_num="PS_TNTC_reached_at_cell__", 
        lab_comments="Lab_Comments", 
        monitor_names="Collected_By", 
        rain_inches="Inches_of_Rain_(in)", 
        tide_stage="Tide_in___out",                 
        time_low_tide="Time_of_Low_Tide", 
        time_high_tide="Time_of_High_Tide", 
        weather="Weather", 
        water_surface="Water_Surface",                 
        wind_direction="Wind_Direction", 
        sampling_method="Phytoplanton_Sample_Method", 
        field_comments= "Field_Notes", 
        descending_transparency="Descending_Transparency_(m)", 
        ascending_transparency="Ascending_Transparency_(m)", 
        bottom_depth_m="Water_Depth_(m)",               
        water_filtered_L="Amount_of_Water_Filtered_(L)",  
        wind_description= "Wind_Speed", 
        grids_counted = "__Grid_Cells_Counted", 
        Copepods= "__of_Copepods",
        wind_speed_knots="Wind_Speed_(mph)") %>%
  unite(., eventRemarks, lab_comments,Comments,field_comments, sep = "|", remove = TRUE)
```

### Fix any site name and locationID inconsistencies

```{r}
site_names <- anecdata_db %>%
  mutate(site=str_replace(site, "MDIBL dock|mdibl dock|.*MDIBL.*","MDIBL Dock"))%>%
  select( site, locationID, eventDate, monitor_names) %>%
  distinct( site, locationID,.keep_all = T) %>%
  arrange(locationID, site) 


anecdata_db <- anecdata_db %>%
  mutate(site=str_replace(site, "MDIBL dock|mdibl dock|.*MDIBL.*","MDIBL Dock"))%>%
  mutate(site= str_replace(site, "eastern bay channel", "Eastern Bay Channel"),
         site= str_replace(site, "Surry - Town Landing", "Surry Town Pier"),
         site= str_replace(site, "Stave", "Stave Island"),
         site= str_replace(site, "Lamoine Shore", "Lamoine Beach"),
         site= str_replace(site, "Brooksville Town Landing", "Brooksville Town Dock"))

site_names_corrected <- read_csv("site_details.csv")

anecdata_db <- left_join(select(anecdata_db,-c(locationID,decimalLatitude,decimalLongitude)),
                      site_names_corrected, by="site") %>%
  select(-locationID) %>%
  rename(locationID=suggested_locationID) %>%
  relocate(locationID:coordinateUncertaintyInMeters, .after=site)
```

### Convert rain to mm from inches

```{r rain}
anecdata_db <- anecdata_db %>%
  mutate(rainfall_mm=rain_inches*25.4) %>%
  select(-rain_inches) 
```

### Time stage
* Shorten to just "In" or "Out"

```{r tide_stage}
anecdata_db <- anecdata_db %>%
  mutate(tide_stage=str_replace( tide_stage, pattern = "In \\(tide is rising\\)", replacement = "In"),
         tide_stage=str_replace(tide_stage, pattern="Out \\(tide is falling\\)", replacement = "Out"))
```

### Convert wind direction from text strings to degrees
* Converting the single letter abbreviations into words and vis-versa with grep/stringr seemed prone to more problems/inconsistencies

```{r wind_direction}
anecdata_db <- anecdata_db %>%
  mutate(
         wind_direction=str_replace(wind_direction, "-No Wind","999"),
         wind_direction=str_replace(wind_direction, "Northwest", "315"),
         wind_direction=str_replace(wind_direction, "Northeast", "35"),
         wind_direction=str_replace(wind_direction, "Southeast", "135"),
         wind_direction=str_replace(wind_direction, "Southwest", "225"),
         wind_direction=str_replace(wind_direction, "West", "270"),
         wind_direction=str_replace(wind_direction, "East", "90"),
         wind_direction=str_replace(wind_direction, "North", "0"),
         wind_direction=str_replace(wind_direction, "South", "90"),
         wind_direction=as.numeric(wind_direction))
```

### Add additional Darwin Core columns

```{r darwin columns}
anecdata_db <- anecdata_db %>%
  mutate(eventDate=strftime(eventDate , "%Y-%m-%dT%H:%M:%S%Z",tz = "Zulu")) %>%
  add_column(countryCode="US") %>%
  mutate(eventID= paste(locationID,  eventDate, sep="_")) %>% 
  mutate(id= paste("MDIBL-habs", locationID,  eventDate, sep="_")) %>% 
  add_column(geodeticDatum="EPSG:4326 WGS84")
```

### Convert wind speed to knots from mph

```{r drop}
anecdata_db <- anecdata_db %>%
  mutate(wind_speed_knots=wind_speed_knots*0.868976)
```

### Reformat monitor names

```{r drop}


```

### Join with historic data of filtered samples and rearrange columns

```{r join}
phyto_db <- read_csv("filtered_water/MDIBL_phyto_db_filter2007_2021.csv")
phyto_full <- bind_rows(phyto_db, anecdata_db) %>%
  relocate(Dinophysis_acuminata:Margalefidinium_polykrikoides, .before="Dinophysis_spp") %>%
  relocate(Karenia, .after="Gyrosigma") %>%
  relocate(Dinophysis_norvegica, .after="Dinophysis_spp") %>% 
  relocate(wind_description, .before="water_filtered_L") %>% 
  relocate(pH:Copepods, .before="water_filtered_L") %>%
  relocate(nutrient_vial_id:Copepods, .before="sampling_method") %>%
  select(-total_phytoplankton) %>%
  relocate(too_numerous_to_count_grid_num, .after=grids_counted) %>%
  add_column(backwashed_volume= 0.015,.after = "grids_counted")
```

### Convert counts to counts per L
* Harmonize the two columns that recorded the number of slide grids counted
* The default number was 200 grids. If no number recorded than 200 were counted.
* The default volume filtered was 10 L. If no number recorded than 10L was filtered.
* The default resuspension volume  was 0.015 L. If no number recorded than 0.015 L was volume.

```{r}
## counts are in cells/
total_rafter_grids <- 100 # per slide
volume_of_rafter <- .001
phyto_full <- phyto_full %>%
  mutate(grids_counted= ifelse(is.na(grids_counted)==T, too_numerous_to_count_grid_num, grids_counted),
         grids_counted=ifelse(is.na(grids_counted)==T, 200, grids_counted),
         grids_counted=ifelse(grids_counted==0, NA, grids_counted),
         water_filtered_L=ifelse(is.na(water_filtered_L)==T, 10, water_filtered_L)) %>%
  mutate(across(Alexandrium:Other_phytoplankton, 
                ~.x* ((1/grids_counted) *   #convert counts to counts per grid
                        (total_rafter_grids/volume_of_rafter) * # counts per grid to counts per L
                        (backwashed_volume/water_filtered_L)))) %>% # factor of concentration/dilution
  select(-too_numerous_to_count_grid_num, -BOD_date,-date_emailed_to_DMR)
```

### Write 2007-present counts per L flat file

```{r write}
write_csv(phyto_full,"filtered_water/phyto_db_filtered_2007_present.csv")
colnames(phyto_full)
```

```{r}
```





